<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Soporte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json">
</head>
<body class="bg-slate-100 h-screen flex flex-col">
    <header class="bg-blue-600 p-4 text-white font-bold shadow-md flex justify-between items-center">
        <span>Chat: {{ worker_nombre }}</span>
        <a href="/" class="text-xs bg-blue-700 px-3 py-1 rounded-lg">Volver</a>
    </header>

    <div id="caja-mensajes" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col">
        {% for m in mensajes %}
        <div class="flex {{ 'justify-end' if m.es_admin else 'justify-start' }}">
            <div class="{{ 'bg-blue-500 text-white rounded-br-none' if m.es_admin else 'bg-white text-slate-800 rounded-bl-none' }} p-3 rounded-2xl shadow-sm max-w-[80%]">
                <p class="text-[10px] font-bold opacity-70 mb-1">
                    {{ "Tú (Admin)" if m.es_admin else worker_nombre }}
                </p>
                <p class="text-sm">{{ m.contenido }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <form id="form-chat" class="p-4 bg-white border-t flex gap-2">
        <input type="text" id="input-msg" placeholder="Escribe un mensaje..." class="flex-1 border-2 border-slate-100 rounded-full px-4 outline-none focus:border-blue-500">
        <button type="submit" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
        </button>
    </form>

    <script>
        const form = document.getElementById('form-chat');
        form.onsubmit = async (e) => {
            e.preventDefault();
            const msg = document.getElementById('input-msg').value;
            if(!msg.trim()) return;

            const formData = new FormData();
            formData.append('worker_id', '{{ worker_id }}');
            formData.append('contenido', msg);
            formData.append('remitente', '{{ "Admin" if es_admin else worker_nombre }}');
            // Nota: Aquí el código de main.py debe decidir si envía true o false en es_admin
            
            await fetch('/enviar_mensaje', { method: 'POST', body: formData });
            location.reload(); 
        };
        
        // Auto-scroll al final
        const caja = document.getElementById('caja-mensajes');
        caja.scrollTop = caja.scrollHeight;
    </script>
</body>
</html>