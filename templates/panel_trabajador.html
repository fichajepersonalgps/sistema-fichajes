<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fichaje GPS - Panel Trabajador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="manifest" href="/static/manifest.json">
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-md mx-auto p-4">
        <header class="bg-white rounded-3xl p-6 shadow-sm mb-4 border-b-4 border-blue-600 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black text-slate-800 capitalize">{{ worker.nombre }}</h1>
                <p id="txtEstado" class="text-[10px] font-bold uppercase tracking-widest mt-1 text-slate-400">Cargando estado...</p>
            </div>
            <a href="/" class="text-[10px] bg-slate-100 px-3 py-1 rounded-full text-slate-400 font-bold uppercase">Salir</a>
        </header>

        <div class="bg-white rounded-3xl p-5 shadow-sm mb-4">
            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Nombre del Servicio / Cliente</label>
            <input type="text" id="inputServicio" placeholder="Ej: Limpieza Oficinas / Obra Norte" 
                   class="w-full p-4 rounded-2xl border-none bg-slate-50 shadow-inner focus:ring-2 focus:ring-blue-500 font-bold text-slate-700">
        </div>

        <div id="map" class="h-64 rounded-3xl shadow-md mb-6 border-4 border-white overflow-hidden"></div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <button id="btnEntrada" onclick="fichar('ENTRADA')" disabled 
                    class="bg-emerald-500 text-white py-8 rounded-3xl font-black text-xl shadow-lg active:scale-95 transition-all disabled:opacity-20">
                ENTRADA
            </button>
            <button id="btnSalida" onclick="fichar('SALIDA')" disabled 
                    class="bg-rose-500 text-white py-8 rounded-3xl font-black text-xl shadow-lg active:scale-95 transition-all disabled:opacity-20">
                SALIDA
            </button>
        </div>
    </div>

    <script>
        let lat, lon;
        const map = L.map('map', { zoomControl: false }).setView([40.41, -3.70], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker;

        // Geolocalización constante
        function iniciarGPS() {
            navigator.geolocation.watchPosition(pos => {
                lat = pos.coords.latitude; 
                lon = pos.coords.longitude;
                
                if (marker) map.removeLayer(marker);
                marker = L.circle([lat, lon], {
                    radius: 12,
                    color: '#2563eb',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.5
                }).addTo(map);
                
                map.setView([lat, lon], 16);
            }, err => {
                alert("Por favor, activa el GPS para poder fichar.");
            }, { enableHighAccuracy: true });
        }

        async function fichar(tipo) {
            const servicio = document.getElementById('inputServicio').value.trim();
            
            if (!servicio) {
                alert("Debes escribir el nombre del servicio (cliente o lugar).");
                return;
            }
            if (!lat) {
                alert("Esperando señal GPS...");
                return;
            }

            const fd = new FormData();
            fd.append('worker_id', '{{ worker.id }}');
            fd.append('tipo', tipo);
            fd.append('lat', lat);
            fd.append('lon', lon);
            fd.append('servicio', servicio);
            
            try {
                const res = await fetch('/fichar', { method: 'POST', body: fd });
                if (res.ok) {
                    localStorage.setItem('en_servicio', tipo === 'ENTRADA');
                    if(tipo === 'ENTRADA') {
                        localStorage.setItem('nombre_servicio', servicio);
                    } else {
                        localStorage.removeItem('nombre_servicio');
                        document.getElementById('inputServicio').value = "";
                    }
                    actualizarInterfaz();
                }
            } catch (error) {
                alert("Error de conexión. Inténtalo de nuevo.");
            }
        }

        function actualizarInterfaz() {
            const esEntrada = localStorage.getItem('en_servicio') === 'true';
            document.getElementById('btnEntrada').disabled = esEntrada;
            document.getElementById('btnSalida').disabled = !esEntrada;
            
            const txt = document.getElementById('txtEstado');
            txt.innerText = esEntrada ? "Estado: EN SERVICIO" : "Estado: FUERA DE SERVICIO";
            txt.className = esEntrada ? "text-emerald-500 font-bold text-[10px] uppercase tracking-widest mt-1" : "text-slate-400 font-bold text-[10px] uppercase tracking-widest mt-1";
            
            // Recuperar el nombre del servicio si ya está dentro
            if (esEntrada && localStorage.getItem('nombre_servicio')) {
                document.getElementById('inputServicio').value = localStorage.getItem('nombre_servicio');
            }
        }

        window.onload = () => {
            iniciarGPS();
            actualizarInterfaz();
        };
    </script>
</body>
</html>