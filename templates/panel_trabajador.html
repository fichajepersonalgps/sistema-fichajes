<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Fichaje</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24">

    <div id="modalLegal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-8 shadow-2xl max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">Aviso de Ubicación</h2>
            <p class="text-sm text-slate-600 mb-6">Para registrar su jornada, la app capturará su posición GPS al fichar. ¿Desea continuar?</p>
            <button onclick="aceptarGPS()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">ACEPTAR</button>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-4 flex justify-between items-center border-b-4 border-blue-500">
            <div>
                <h1 class="text-lg font-black text-slate-800">Hola, {{ worker.nombre }}</h1>
                <p id="badgeEstado" class="text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full inline-block mt-1"></p>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 font-mono">{{ worker.dni_nie }}</p>
            </div>
        </div>

        <div id="map" class="h-48 rounded-2xl shadow-inner mb-6 border-4 border-white overflow-hidden"></div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <button id="btnEntrada" onclick="fichar('ENTRADA')" disabled class="bg-emerald-500 text-white p-6 rounded-3xl font-black shadow-lg active:scale-95 transition-all">ENTRADA</button>
            <button id="btnSalida" onclick="fichar('SALIDA')" disabled class="bg-rose-500 text-white p-6 rounded-3xl font-black shadow-lg active:scale-95 transition-all">SALIDA</button>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-sm">
            <h3 class="text-slate-400 text-[10px] font-black uppercase mb-2">Resumen</h3>
            <p class="text-[9px] text-slate-400 mt-2 italic">* Los reportes detallados son gestionados por el Administrador.</p>
        </div>
    </div>

    <a id="btnChatFlotante" href="/chat_lista/{{ worker.id }}" class="fixed bottom-6 right-6 bg-blue-600 text-white p-5 rounded-full shadow-2xl border-4 border-white z-50 active:scale-90 transition-transform">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
        <span id="notificacionChat" class="hidden absolute -top-1 -right-1 bg-rose-500 w-6 h-6 rounded-full border-2 border-white flex items-center justify-center text-[10px] font-bold animate-bounce text-white">!</span>
    </a>

    <script>
        let lat, lon;
        const map = L.map('map').setView([40.41, -3.70], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker;

        window.onload = () => {
            if (localStorage.getItem('gps_autorizado') === 'true') {
                document.getElementById('modalLegal').classList.add('hidden');
                activarGPS();
            }
            actualizarInterfaz(localStorage.getItem('en_servicio') === 'true');
            chequearNuevosMensajes();
        };

        function aceptarGPS() {
            localStorage.setItem('gps_autorizado', 'true');
            document.getElementById('modalLegal').classList.add('hidden');
            activarGPS();
        }

        function activarGPS() {
            navigator.geolocation.watchPosition(pos => {
                lat = pos.coords.latitude; lon = pos.coords.longitude;
                if (marker) map.removeLayer(marker);
                marker = L.marker([lat, lon]).addTo(map);
                map.setView([lat, lon], 16);
            }, null, { enableHighAccuracy: true });
        }

        function actualizarInterfaz(estaTrabajando) {
            document.getElementById('btnEntrada').disabled = estaTrabajando;
            document.getElementById('btnSalida').disabled = !estaTrabajando;
            const badge = document.getElementById('badgeEstado');
            badge.innerText = estaTrabajando ? "En Servicio" : "Fuera de Servicio";
            badge.className = estaTrabajando ? "text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full inline-block mt-1 bg-emerald-100 text-emerald-600" : "text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full inline-block mt-1 bg-slate-100 text-slate-400";
        }

        async function fichar(tipo) {
            if (!lat) return alert("Esperando señal GPS...");
            const fd = new FormData();
            fd.append('worker_id', '{{ worker.id }}'); fd.append('tipo', tipo);
            fd.append('lat', lat); fd.append('lon', lon);
            const res = await fetch('/fichar', { method: 'POST', body: fd });
            if (res.ok) {
                localStorage.setItem('en_servicio', tipo === 'ENTRADA');
                actualizarInterfaz(tipo === 'ENTRADA');
            }
        }

        async function chequearNuevosMensajes() {
            try {
                const res = await fetch('/mensajes_nuevos/{{ worker.id }}');
                const data = await res.json();
                const globo = document.getElementById('notificacionChat');
                if (data.mensajes.length > 0) globo.classList.remove('hidden');
                else globo.classList.add('hidden');
            } catch (e) {}
        }
        setInterval(chequearNuevosMensajes, 5000);
    </script>
</body>
</html>