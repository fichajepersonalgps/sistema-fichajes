<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Fichaje</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
            <h1 class="text-xl font-bold text-slate-800">Hola, {{ worker.nombre }}</h1>
            <p class="text-sm text-slate-500">DNI: {{ worker.dni_nie }}</p>
        </div>

        <div id="map" class="h-64 rounded-2xl shadow-inner mb-4 border-2 border-white"></div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="fichar('ENTRADA')" class="bg-emerald-500 text-white p-6 rounded-2xl font-black shadow-lg active:scale-95 transition-all text-lg">ENTRADA</button>
            <button onclick="fichar('SALIDA')" class="bg-rose-500 text-white p-6 rounded-2xl font-black shadow-lg active:scale-95 transition-all text-lg">SALIDA</button>
        </div>
    </div>

    <script>
        let lat, lon;
        const map = L.map('map').setView([40.4167, -3.7037], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker;

        navigator.geolocation.watchPosition(pos => {
            lat = pos.coords.latitude;
            lon = pos.coords.longitude;
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon]);
        });

        async function fichar(tipo) {
            if (!lat) return alert("Esperando señal GPS...");
            const formData = new FormData();
            formData.append('worker_id', '{{ worker.id }}');
            formData.append('tipo', tipo);
            formData.append('lat', lat);
            formData.append('lon', lon);
            formData.append('servicio', 'General');

            const res = await fetch('/fichar', { method: 'POST', body: formData });
            if (res.ok) alert("Fichaje de " + tipo + " registrado con éxito");
        }
    </script>
</body>
</html>